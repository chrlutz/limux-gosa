#!/bin/bash
pidfile="$(sed -n 's/^pid-file *= *\([^ ]*\)/\1/p' /etc/gosa-si/server.conf)"
test -z "$pidfile" && pidfile=/var/run/gosa-si-server.pid

foreground="0"

faus=0

args=()
while [ $# != 0 ]; do
  case "$1" in
   -f)
      foreground="1"
      shift
      continue
      ;;
   -v*)
      faus=$(($faus + ${#1} - 1))
      shift
      continue
      ;;
  esac
  args=("${args[@]}" "$1")
  shift
done

case $faus in
  0) ;;
  1|2|3|4|5) args=("-v" "${args[@]}") ;;
  *) args=("-vv" "${args[@]}") ;;
esac

rm -f "$pidfile"

# We must call /usr/lib/gosa-si-server because the binary has to be named gosa-si-server,
# because start-stop-daemon tests this name.
# It is not enough to pass argv[0]=gosa-si-server via exec.

if [ $foreground = 1 ]; then
  echo "$BASHPID" >"$pidfile"
  exec /usr/lib/gosa-si-server "${args[@]}"
else
  (
    trap "" SIGHUP
    echo "$BASHPID" >"$pidfile"
    exec &>/dev/null </dev/null setsid /usr/lib/gosa-si-server "${args[@]}"
  )&
fi
